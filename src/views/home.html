<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Events — Header</title>
  <style>
    :root{
      --bg1: #0f172a;
      --bg2: #0b1220;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --accent: #6ee7b7;
      --muted: rgba(255,255,255,0.6);
      --danger: #ff7b7b;
      --font: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:2rem;
    }

    .wrap{width:100%;max-width:1100px}

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      padding:0.6rem 1rem;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      backdrop-filter: blur(6px);
      margin-bottom:1rem;
    }

    /* Left side (title) */
    .title{display:flex;align-items:center;gap:.75rem}
    .logo{
      width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent), #4ade80);
      display:grid;place-items:center;font-weight:700;color:#072;
      box-shadow: 0 4px 14px rgba(110,231,183,0.12);
    }
    h1{margin:0;font-size:1.05rem;color:#fff;letter-spacing:0.2px}
    .sub{font-size:0.78rem;color:var(--muted);opacity:.9}

    /* Right side (user + actions) */
    .actions{display:flex;align-items:center;gap:.75rem}
    .user{display:flex;align-items:center;gap:.65rem}
    .avatar{width:36px;height:36px;border-radius:999px;background:linear-gradient(135deg,var(--accent), #2dd4bf);display:flex;align-items:center;justify-content:center;font-weight:700;color:#062;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.25)}
    .username{font-weight:600;color:#fff}
    .username-small{font-size:0.86rem;color:var(--muted)}

    /* Create button */
    .btn-create{
      --pad:0.55rem 0.9rem;
      background:linear-gradient(90deg,var(--accent), #34d399);
      color:#042;
      border:none;
      padding:var(--pad);
      font-weight:700;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(110,231,183,0.12);
      transition:transform .12s ease, box-shadow .12s ease;
      display:inline-flex;align-items:center;gap:.5rem;
    }
    .btn-create:active{transform:translateY(1px)}
    .btn-create .plus{font-size:1.05rem}

    /* Auth buttons (login/signup) */
    .auth-actions{display:flex;gap:.5rem;align-items:center}
    .btn-login,.btn-signup{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.45rem .7rem;border-radius:8px;color:var(--muted);cursor:pointer}
    .btn-signup{background:linear-gradient(90deg,#fff1,#fff2);color:#fff;border:none}

    /* small logout button */
    .btn-logout{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.35rem .6rem;border-radius:8px;color:var(--muted);cursor:pointer;font-size:0.9rem}

    /* Content */
    main.content{margin-top:0}
    .events-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .card{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.02));padding:0.9rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 24px rgba(2,6,23,0.6);color:#fff}
    .card h3{margin:0 0 .4rem 0;font-size:1rem}
    .meta{font-size:0.82rem;color:var(--muted);margin-bottom:.5rem}
    .desc{font-size:0.92rem;color:rgba(255,255,255,0.9)}
    .empty{padding:2.2rem;border-radius:12px;text-align:center;color:var(--muted);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:60}
    .modal{width:100%;max-width:560px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:1rem;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(2,6,23,0.7)}
    .modal h2{margin:0 0 0.6rem 0;color:#fff}
    .field{display:flex;flex-direction:column;margin-bottom:.6rem}
    .field label{font-size:0.82rem;color:var(--muted);margin-bottom:.25rem}
    .field input,.field textarea{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);padding:0.5rem;border-radius:8px;color:#fff}
    .modal-footer{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.6rem}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:.45rem .7rem;border-radius:8px;color:var(--muted);cursor:pointer}

    /* small screens */
    @media (max-width:520px){
      .header{padding:.5rem .75rem}
      h1{font-size:0.98rem}
      .username{display:none}
      .btn-create{padding:.45rem .7rem}
      .events-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header" role="banner" aria-label="Site header">
      <div class="title">
        <div class="logo" aria-hidden="true">E</div>
        <div>
          <h1>Events</h1>
          <div class="sub">Upcoming &amp; past</div>
        </div>
      </div>

      <div class="actions">
        <!-- Create button stays in DOM but will be hidden for anonymous users -->
        <button class="btn-create" id="open-create" aria-haspopup="dialog">
          <span class="plus">＋</span>
          <span>Create Event</span>
        </button>

        <!-- Auth area: either user info (when logged in) or login/signup buttons -->
        <div class="auth-actions" id="auth-actions" style="display:none">
          <button class="btn-login" id="btn-login">Log in</button>
          <button class="btn-signup" id="btn-signup">Sign up</button>
        </div>

        <div class="user" id="user-block" role="navigation" aria-label="User menu" style="display:none">
          <div class="avatar" aria-hidden="true">A</div>
          <div>
            <div class="username" id="username">asasasa</div>
            <div class="username-small">Organizer</div>
          </div>
          <button class="btn-logout" id="btn-logout" title="Log out">Log out</button>
        </div>
      </div>
    </header>

    <main class="content">
      <div id="events" class="events-grid">
        <div class="empty" id="empty">No events yet — click Create Event to add one.</div>
      </div>
    </main>

    <div class="modal-backdrop" id="modal">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title">Create event</h2>
        <div class="field">
          <label for="title">Title</label>
          <input id="title" placeholder="Event name" />
        </div>
        <div class="field">
          <label for="date">Date & time</label>
          <input id="date" type="datetime-local" />
        </div>
        <div class="field">
          <label for="desc">Description</label>
          <textarea id="desc" rows="4" placeholder="Short description"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn-ghost" id="close">Cancel</button>
          <button class="btn-create" id="save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    serverUrl = ""
    const open = document.getElementById('open-create');
    const modal = document.getElementById('modal');
    const close = document.getElementById('close');
    const save = document.getElementById('save');
    const eventsEl = document.getElementById('events');
    const emptyEl = document.getElementById('empty');
    const userBlock = document.getElementById('user-block');
    const usernameEl = document.getElementById('username');
    const authActions = document.getElementById('auth-actions');
    const btnLogin = document.getElementById('btn-login');
    const btnSignup = document.getElementById('btn-signup');
    const btnLogout = document.getElementById('btn-logout');

    function showModal(){
      document.getElementById('title').value = '';
      document.getElementById('date').value = '';
      document.getElementById('desc').value = '';
      modal.style.display = 'flex';
      setTimeout(()=> document.getElementById('title').focus(), 50);
    }
    function hideModal(){ modal.style.display = 'none'; }

    if (open) open.addEventListener('click', showModal);
    if (close) close.addEventListener('click', hideModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) hideModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideModal(); });

    function renderEvent(ev){
      const existingEmpty = document.getElementById('empty');
      if(existingEmpty) existingEmpty.remove();

      const card = document.createElement('article');
      card.className = 'card';
      const title = document.createElement('h3'); title.textContent = ev.title || 'Untitled';
      const meta = document.createElement('div'); meta.className = 'meta';
      const dt = ev.date ? new Date(ev.date) : null;
      meta.textContent = dt ? dt.toLocaleString('en-IN', {dateStyle:'medium', timeStyle:'short'}) : 'No date';
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = ev.desc || ev.description || '';
      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(desc);
      eventsEl.prepend(card);
    }

    async function loadEvents(){
      try{
        const res = await fetch(serverUrl + '/event/getEvents',);
        if (!res.ok){
          console.warn('Failed to load events', res.status);
          return;
        }
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0){
          eventsEl.innerHTML = '<div class="empty" id="empty">No events yet — click Create Event to add one.</div>';
          return;
        }
        eventsEl.innerHTML = '';

        data.sort((a,b)=>{
          const ad = a.event_date ? new Date(a.event_date) : 0;
          const bd = b.event_date ? new Date(b.event_date) : 0;
          return bd - ad;
        });

        data.forEach(ev => {
          renderEvent({
            id: ev.id,
            title: ev.title,
            date: ev.event_date || ev.eventDate || null,
            desc: ev.description
          });
        });
      }catch(err){
        console.error('Error loading events', err);
      }
    }

    if (save) save.addEventListener('click', async ()=>{
      const title = document.getElementById('title').value.trim();
      const date = document.getElementById('date').value;
      const desc = document.getElementById('desc').value.trim();
      if(!title){ alert('Please enter an event title'); return; }
      try{
        const result = await fetch(serverUrl + "/event/postEvent", {method:"POST", 
          headers: {"content-type" : "application/json"}, 
          credentials: 'include',
          body : JSON.stringify({title, eventDate : date, description : desc})
        });
        if(!result.ok){
          const txt = await result.text();
          console.warn('Save failed:', result.status, txt);
          alert('Could not save event.');
          return;
        }
        const ev = { id: Date.now(), title, date: date || null, desc };
        renderEvent(ev);
        hideModal();
      }catch(err){
        console.error(err);
        alert('Network error when saving event.');
      }
    });

    function setUser(user){
      if (!user) return setLoggedOut();
      usernameEl.textContent = user.username || user.name || user.email || 'User';
      userBlock.style.display = 'flex';
      authActions.style.display = 'none';
      if (open) open.style.display = 'inline-flex';
    }

    function setLoggedOut(){
      userBlock.style.display = 'none';
      authActions.style.display = 'flex';
      if (open) open.style.display = 'none';
    }

    async function checkAuth(){
      try{
        const res = await fetch(serverUrl + '/me', {credentials: 'include'});
        if (!res.ok){
          setLoggedOut();
          return;
        }
        const data = await res.json();
        const user = data.user || data;
        setUser(user);
      }catch(err){
        console.warn('Auth check failed', err);
        setLoggedOut();
      }
    }

    if (btnLogin) btnLogin.addEventListener('click', ()=> window.location.href = '/login');
    if (btnSignup) btnSignup.addEventListener('click', ()=> window.location.href = '/signup');

    if (btnLogout) btnLogout.addEventListener('click', async ()=>{
      try{
        const result = await fetch(serverUrl + '/auth/logout', {method: 'POST', credentials: 'include'});
        if(result.status == 200) {
          window.location.reload();
        }
      }catch(err){
        console.warn('Logout failed', err);
      }
    });

    checkAuth();
    loadEvents();
  </script>
</body>
</html>
